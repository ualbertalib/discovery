# https://groups.google.com/forum/#!topic/rubyonrails-security/IOO1vNZTzPA
# but adapted for Rack 1.6-stable https://github.com/rack/rack/blob/47a1fd73fc77f094573f4215b0fc884f4ac1c03c/lib/rack/directory.rb#L79-L105

Rack::Directory.prepend(Module.new do
  def list_directory
    @files = [['../', 'Parent Directory', '', '', '']]

    url_head = (@script_name.split('/') + @path_info.split('/')).map do |part|
      Rack::Utils.escape part
    end

    Dir.entries(@path).reject { |e| e.start_with?('.') }.sort.each do |node|
      stat = stat(node)
      next unless stat

      basename = F.basename(node)
      ext = F.extname(node)

      url = F.join(*url_head + [Rack::Utils.escape(basename)])
      size = stat.size
      type = stat.directory? ? 'directory' : Mime.mime_type(ext)
      size = stat.directory? ? '-' : filesize_format(size)
      mtime = stat.mtime.httpdate
      url << '/'  if stat.directory?
      basename << '/' if stat.directory?

      @files << [url, basename, size, type, mtime]
    end

    [200, { CONTENT_TYPE => 'text/html; charset=utf-8' }, self]
  end
end)
